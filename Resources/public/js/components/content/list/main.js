/**
 * Generated by https://github.com/alexander-schranz/sulu-backend-bundle.
 */

define(['jquery'], function ($) {
    'use strict';

    var constants = {
        toolbarId: 'list-toolbar',
        toolbarKey: 'lists',
        listId: 'list-list',
        endPointUrl: '/admin/api/l91/form/lists',
        toolbarSearchFields: ['email'],
        fieldsAction: '/admin/api/l91/form/lists/fields'
    };

    return {

        layout: function() {
            return {
                extendExisting: true,
                content: {
                    width: 'fixed',
                    leftSpace: true,
                    rightSpace: true
                }
            };
        },

        initialize: function() {
            this.render();
            this.initPreview();
        },

        /**
         * Initilize the sulu preview
         */
        initPreview: function() {
            this.sandbox.emit('sulu.preview.initialize', null, true);
        },

        /**
         * Renders the component
         */
        render: function () {
            this.sandbox.dom.html(this.$el,
                '<div id="' + constants.toolbarId + '"></div>' +
                '<div id="' + constants.listId + '"></div>'
            );

            var urlParameters = {
                'webspace': this.options.webspace,
                'locale': this.options.language,
                'template': this.options.template,
                'uuid': this.options.id
            };

            var queryString = '?' + $.param(urlParameters);

            // init list-toolbar and datagrid
            this.sandbox.sulu.initListToolbarAndList.call(
                this,
                constants.toolbarKey,
                constants.fieldsAction + queryString,
                {
                    // options for the header (list-toolbar)
                    el: this.$find('#' + constants.toolbarId),
                    template:  this.sandbox.sulu.buttons.get({
                        settings: {
                            options: {
                                id: 'settings',
                                dropdownItems: {
                                    export: {
                                        options: {
                                            title: 'public.export',
                                            icon: 'download',
                                            callback: function() {
                                                var $container = $('<div/>');
                                                $('body').append($container);

                                                App.start([{
                                                    name: 'csv-export@suluadmin',
                                                    options: {
                                                        el: $container,
                                                        urlParameter: urlParameters,
                                                        url: constants.endPointUrl + '.csv'
                                                    }
                                                }]);
                                            }.bind(this)
                                        }
                                    },
                                    columnOptions: {
                                        options: {
                                            type: 'columnOptions'
                                        }
                                    }
                                }
                            }
                        }
                    }),
                    instanceName: this.instanceName
                },
                {
                    // options for the content (datagrid)
                    el: this.$find('#' + constants.listId),
                    instanceName: this.instanceName,
                    url: constants.endPointUrl + queryString,
                    resultKey: 'entries',
                    searchFields: constants.toolbarSearchFields,
                    viewOptions: {
                        table: {
                            selectItem: false,
                            fullWidth: true
                        }
                    }
                }
            );
        }
    };
});
